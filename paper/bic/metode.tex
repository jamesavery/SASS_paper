\section{Method}\label{sec:method}
% Spatial correlation 2d histograms (den nemme, 1 2d hist)
In this section, we will describe the method for exploiting spatial correlation based of the 2D-histograms of the tomographies.
We will start by motivating the problem, then give an overview of how we solve the problem, with a final detailed walkthrough of each step of the overall workflow.

\subsection{1-dimensional histograms}
%diskuter overlappende materialer
If we look at a 1D-histogram of the voxel intensity of a tomography, as shown in~\Cref{fig:1d-hist}, then even though we are able to distinguish different distributions, we see that there is a large overlap leading to global thresholding being infeasible, at least for the distributions towards the center.
This is because the voxel intensity is not a globally defined value, as~\Cref{sec:physics} explains, which means that the different materials cover ranges of intensities, which blend together in the histogram.

\begin{figure}
    \centering
    \carl{TODO 1D histogram of a tomography. Skal måske have nogle fordelinger "fittet" ind, så man kan se overlappet?}
    \caption{1-dimensional histogram of the voxel intensities of a tomography.}
    \label{fig:1d-hist}
\end{figure}

\subsection{Preprocessing}\label{sec:preprocess}
To reduce the complexity of the segmentation process, we preprocess the data by removing redundant information.
From our previous work, we are able to obtain two masks: an implant mask and a bone mask.

Since the material of the implant is radically different from the rest of the sample, obtaining the implant mask through global thresholding is trivial. In order to remove the gaps within the implant, we apply a closing morphology filter. The implant mask is then used to compute the principal axes from the implant in order to compute what is considered air and what is considered resin. From this information, we obtain the bone mask. These two masks are applied throughout the steps to filter out noise in the tomography.

\carl{Til James: er denne beskrivelse ok? Jeg prøvede at springe nemt henover det.}

\subsection{Exploiting spatial information}
As described in~\Cref{sec:physics}, the intensities vary according to their positioning, leading us to utilize spatial information in the tomography. 
%Show the correlation of x,y,z,r to histograms 2d
In order to include spatial information, we consider \textit{expanding} a dimension to produce multiple 1D histograms.
Each histogram is computed by locking the dimension in question and produce the 1D histogram, combining these for each entry in the expanded axis into a new 2-dimensional histogram.
Specifically, we consider the radius ($r$) dimension from the center of the implant, as the intensities vary the most closest to the implant. 
The algorithm for computing the 2-dimensional histogram for the radius can be seen in~\Cref{alg:2dhists} with the resulting histograms plotted in~\Cref{fig:2dhists}.
From this plot, we see two prominent distributions that change along the $r$ axis.
However, close to the implant (as $r$ goes towards 0), the intensities starts overlapping indicating the need for another solution.

\carl{discuss the effects with references to the physics (previous section). Kunne jeg godt bruge hjælp til.}

% Kept for historical reasons.
%\begin{algorithm}
%    \caption{2-dimensional histograms. Allocation also implies zero initialization.}
%    \label{alg:2dhists}
%    \begin{algorithmic}
%        \Function {2D\_hist} {$voxels[n_z,n_y,n_x],c_x,c_y,n_{bins},v_{min},v_{max}$}
%            \State $n_r \gets \left\lfloor\sqrt{\left\lfloor \frac{n_x}{2} \right\rfloor^2 + \left\lfloor \frac{n_y}{2} \right\rfloor^2}\right\rfloor+1$
%            \State \textbf{allocate} $h_z[n_z,n_{bins}], h_y[n_y,n_{bins}]$
%            \State \textbf{allocate} $h_x[n_x,n_{bins}], h_r[n_r,n_{bins}]$
%            \For {$z,y,x$ \textbf{in} $0{:}n_z,0{:}n_y,0{:}n_x$}
%                \State $v \gets voxels[z,y,x]$
%                \If {$v_{min} \leq v \leq v_{max}$}
%                    \State $v_{i} \gets (n_{bins}-1) \cdot \frac{v - v_{min}}{v_{max} - v_{min}}$
%                    \State $r \gets \left\lfloor\sqrt{(x-c_x)^2 + (y-c_y)^2}\right\rfloor$
%                    \State $h_z[z,v_{i}]{+}{+}$
%                    \State $h_y[y,v_{i}]{+}{+}$
%                    \State $h_x[x,v_{i}]{+}{+}$
%                    \State $h_r[r,v_{i}]{+}{+}$
%                \EndIf
%            \EndFor
%            \Return $h_z,h_y,h_z,h_r$
%        \EndFunction
%    \end{algorithmic}
%\end{algorithm}

\begin{algorithm}
    \caption{2-dimensional radius histogram.}
    \label{alg:2dhists}
    \begin{algorithmic}
        \Function {hist\_r} {$voxels[n_z,n_y,n_x],c_x,c_y,n_{bins},v_{min},v_{max}$}
            \For {$z,y,x$ \textbf{in} $0{:}n_z,0{:}n_y,0{:}n_x$}
                \State $v \gets voxels[z,y,x]$
                \If {$v_{min} \leq v \leq v_{max}$}
                    \State $v_{i} \gets (n_{bins}-1) \cdot \frac{v - v_{min}}{v_{max} - v_{min}}$
                    \State $r \gets \left\lfloor\sqrt{(x-c_x)^2 + (y-c_y)^2}\right\rfloor$
                    \State $h_r[r,v_{i}]{+}{+}$
                \EndIf
            \EndFor
            \Return $h_r$
        \EndFunction
    \end{algorithmic}
\end{algorithm}

\begin{figure}
    \centering
    %\includegraphics[width=.49\linewidth]{figures/zb-bone_region3.png}
    %\includegraphics[width=.49\linewidth]{figures/yb-bone_region3.png}
    %\includegraphics[width=.49\linewidth]{figures/xb-bone_region3.png}
    %\includegraphics[width=\linewidth]{figures/rb-bone_region3.png}
    \includegraphics[width=\linewidth]{figures/rb-bone_region3.pdf}
    \caption{2D radius histogram. The y-axis depicts radius, with the x-axis being voxel intensity.}
    \label{fig:2dhists}
\end{figure}

\subsection{Field histograms}
%Show that the fields can perfectly seperate
%discuss all the way to implant contact
In order to obtain spatial information based on the relation to the implant, we construct two \textit{field} representations: Euclidian Distance Transform (EDT) and Diffusion.

%EDT is good overall, but difficult close to the implant.
EDT computes each voxel as the euclidian distance to the implant. 
This makes for a generally good representation for all but the voxels that are close to the implant.
The shortcoming near the implant is mainly due to the fact that the voxels in the grooves of the implant has the same distance, and thus gets the same value, as the voxels next to the threads of the implant, as is shown in~\Cref{fig:edt-vs-diffusion}.
This is not entirely accurate, as the implant produces a "glowing" effect similar to beam-hardening, as discussed in~\Cref{sec:beam-hardening}.

%Use diffusion to "zoom in" on the implant, as it is good close to the implant, but throws everything far away into the same bin
To get better correction close to the implant, we utilize diffusion where the implant "glows" further accumulating the value when a voxel is surrounded by implant.
This is shown in~\Cref{fig:edt-vs-diffusion}, where the voxels in the grooves are affected by multiple implant voxels.

% \begin{figure}
%     \centering
%     \includegraphics[width=.7\linewidth]{figures/edt-diffusion.png}
%     \caption{High-quality render of the different field computations close to the implant in the YZ plane. The EDT is depicted in blue, where we see that $p_1$ and $p_2$ has the same distance. Diffusion is depicted in green, where we see multiple arrows contributing to the value of $p_1$.
%     \label{fig:edt-vs-diffusion}
% \end{figure}
\aleksandar{Havde du fået lavet en nice edt vs diffusion plot? hilsen carl}

While Diffusion works well on voxels close to the implant, it assigns the same value to the voxels far from the implant. 
As such, an optimal solution is to use both the EDT and the diffusion field to better represent both voxels that are far away, as well as the ones that are close to the implant.
We achieve this by adding the two fields together, producing a final combined field.

%Show that the distance to the implant in edt will be the same in the grooves of the screw compared to the threads of the screw. This is "fixed" with diffusion, as the grooves will be brigher as it is surrounded by more implant.

\subsection{Walkthrough of the method}
This section will describe the steps of the method in detail for going from tomography to material probability distributions.
\carl{flavortext}

\subsubsection{Overview}
%Coarse steps, explain the idea
The coarse steps of the segmentation method are:
\begin{enumerate}
    \item Compute the EDT and Diffusion fields to give each voxel spatial information about its relation to the implant.
    \item Compute frequency distributions of voxel values as functions of field values as 2D histograms.
    \item Find the materials within the 2D histograms as ridges, using image processing techniques.
    \item From the ridges, compute initial approximate frequence distributions of each material, which are then optimized to fit the 2D histograms. 
    \item From the optimized distributions, we derive probability distributions for material classification.
\end{enumerate}
The computed distributions approximate the conditional probabilities $P(m|v,x)$ that a particular voxel
is material $m$ given that it has value $v$ and field value $x$. 

\james{TODO: Forklar bedre. Adskil ny segmenteringsmetode og anvendelse til BIC}

These steps are also summarized in the flow chart in~\Cref{fig:flowchart}.

\begin{figure}
    \centering
    \begin{tikzpicture}
        %\node (voxels) at (0,2) {tomography};
        %\node[anchor=east] (implant) at (-1,1) {implant mask};
        %\node[anchor=west] (bone) at (1,1) {bone mask};
        %\draw[draw] (implant.north west) rectangle (bone.south east);

        \node[draw] (field) at (0,0) {1. Compute fields};
        \node[draw, below = of field] (hists) {2. Compute 2D histograms};
        \node[draw, below = of hists] (curvs) {3. Find Ridges};
        \node[draw, below = of curvs] (probs) {4. Compute probabilities};
        \node[draw, below = of probs] (segm)  {5. Segment the voxels};
        \node[draw, below = of segm]  (blood) {6. Compute blood network};
        \node[draw, below = of blood] (bic)   {7. Compute bone- and blood-implant contact};

        %\path[draw, ->] (voxels) -- (field);
        %\path[draw, ->] (implant) -| ([shift={(-.5,0)}]field.north);
        %\path[draw, ->] (bone) -| ([shift={(.5,0)}]field.north);
        \path[draw, ->] (field) -- (hists);
        \path[draw, ->] (hists) -- (curvs);
        \path[draw, ->] (curvs) -- (probs);
        \path[draw, ->] (probs) -- (segm);
        \path[draw, ->] (segm) -- (blood);        
        \path[draw, ->] (blood) -- (bic);
    \end{tikzpicture}
    \caption{Flowchart depicting the steps of the method.
    \carl{Kan måske arrangeres ligesom Davids ting oversigt? Giver måske kun mening hvis der var mere end bare segmentation -> bic}}
    \label{fig:flowchart}
\end{figure}

\subsubsection{Segmentation}
The segmentation is computed in steps 1-5. For each step we will describe the process, showing the algorithm where applicable, along with the the intermediate results. 

\vspace{\baselineskip}
\noindent\textit{\textbf{1. Field computations}}
Both fields are computed from the implant mask, as described in~\Cref{sec:preprocess}.
EDT is computed using the Python package \texttt{edt}~\cite{pypi-edt}. It takes the implant mask and sets every non-set voxel to be the euclidian distance to the nearest implant voxel.

For diffusion, rather than solving the diffusion equation, we approximate using multiple convolutions of a 3D-gaussian kernel.
Furthermore, instead of a single pass with a 3D-kernel, we apply 3 1D convolutions, one in each dimension, to the tomography, obtaining the same result as a regular 3D-gaussian kernel.
The algorithm can be seen in~\Cref{alg:diffusion}, with x, y, and z slices in~\Cref{fig:field-slices}

\begin{algorithm}
    \caption{Diffusion approximation.}
    \label{alg:diffusion}
    \begin{algorithmic}
        \Function {Diffusion} {$voxels[n_z*n_y*n_x], repitions, kernel[2*k+1]$}
            \State $S \gets [n_y * n_x, n_x, 1]$
            \State $N \gets [n_z, n_y, n_x]$
            \State $buf_0[:] \gets voxels[:]$
            \For {$rep$ \textbf{in} $repitions$}
                \For {$dim$ \textbf{in} $dimensions$}
                    \For {$z,y,x$ \textbf{in} $0{:}n_z,0{:}n_y,0{:}n_x$}
                        \State $X \gets [z,y,x]$
                        \State $i_{start} \gets - \min (k, X[dim])$
                        \State $i_{end} \gets \min (k, N[dim] - X[dim] - 1)$
                        \State $i_{global} \gets z*S[0] + y*S[1] + x*S[2]$
                        \For {$i$ \textbf{in} $i_{start}:i_{end}$}
                            \State $i_{offset} \gets i_{global} + i*S[dim]$
                            \State $buf_1[index] \gets buf_0[i_{offset}] * kernel[i+k]$
                        \EndFor
                    \EndFor
                    \State $buf_0[:] \gets buf_1[:]$
                \EndFor
            \EndFor
            \Return $buf_0$
        \EndFunction
    \end{algorithmic}
\end{algorithm}

\begin{figure}
    \carl{TODO show x, y, and z slices of the EDT and Diffusion field. Either each field seperate or combined?}
    \caption{Slices of the EDT field at different collapsed dimensions.}
    \label{fig:field-slices}
\end{figure}

%EDT + Diffusion
To obtain good seperation both close to the implant and far away, we combine the two fields into a single one as shown in~\Cref{alg:field-comb}. The slices are shown in~\Cref{fig:field-slices}.

\begin{algorithm}
    \caption{Field combination}
    \label{alg:field-comb}
    \begin{algorithmic}
        \Function {field\_combine} {$f_{edt}, f_{dif}$}
            \State $r \gets f_{dif} - \frac{f_{edt}}{\max (f_{edt})}$
            \State $r \gets r - \min (f_{dif})$
            \State $r \gets \frac{r}{\max (f_{dif})}$

            \Return $r$
        \EndFunction
    \end{algorithmic}
\end{algorithm}

\vspace{\baselineskip}
\noindent\textbf{2. 2D histograms} \\

From the combined fields we compute a 2D histogram with the field value on the y-axis and the voxel intensity on the x-axis. 
This allows us to see the distribution of voxel values, based off their relative position from the implant.
The algorithm for the field histogram can be seen in~\Cref{alg:field-hist} with a plot of the resulting histogram in~\Cref{fig:field-hist}.
We see that the voxel intensities shift based off how close to the implant clearly showing two seperable distributions.

\begin{algorithm}
    \caption{Field 2D histograms.}
    \label{alg:field-hist}
    \begin{algorithmic}
        \Function {Field\_hist} {$voxels[n_z,n_y,n_x], field[n_z,n_y,n_x],$ \newline $v_{bins}, v_{min}, v_{max}, f_{bins}, f_{min}, f_{max}$}
            \For {$z,y,x$ \textbf{in} $0{:}n_z,0{:}n_y,0{:}n_x$}
                \State $v \gets voxels[z,y,x]$
                \If {$v_{min} \leq v \leq v_{max}$}
                    \State $f \gets voxels[z,y,x]$
                    \If {$f_{min} \leq f \leq f_{max}$}
                        \State $v_i \gets (v_{bins} - 1) - \frac{v - v_{min}}{v_{max} - v_{min}}$
                        \State $f_i \gets (f_{bins} - 1) - \frac{f - f_{min}}{f_{max} - f_{min}}$
                        \State $h[f_i,v_i]{+}{+}$
                    \EndIf
                \EndIf
            \EndFor
            \Return $h$
        \EndFunction
    \end{algorithmic}
\end{algorithm}
\carl{look at indenting the function arguments in~\Cref{alg:field-hist}}

\begin{figure}
    %\includegraphics[width=\linewidth]{figures/fb-edt-bone_region3.png}
    \includegraphics[width=\linewidth]{figures/fb-gauss+edt-bone_region3.pdf}
    \caption{2D field histogram. Note that there are two clearly seperated ridges, which make up the different materials.}
    \label{fig:field-hist}
\end{figure}

\vspace{\baselineskip}
\noindent\textbf{3. Isolate the materials} \\
The next step is to isolate the different materials spatially, which is done through the field histogram.
For our first attempt, we applied otsu's threshold to each each row in the 2D histogram. 
While this provided good results for two clearly defined distributions, it started to fail both because of lack of samples or because the histogram did not contain two distributions, which is an assumption of the otsu threshold. 
These two effects occurred in the edges (both closest and furthest), which would bleed into the later steps of the segmentation process. 

Our next solution was to rather than finding the threshold value in between the distributions, we started finding the distributions by finding the ridges of the 2D histogram. 
We do this by applying a series of image processing techniques, which~\Cref{alg:material} describes.
Each of the resultiong contours become their own material, which are then labeled as material 1 and 2 respectively for this particular sample. For samples that would contain more than two distributions, the same algorithm should apply, as long as the distributions does not overlap. 

\begin{algorithm}
    \caption{Material isolation.}
    \label{alg:material}
    \begin{algorithmic}
        \Function {Materials} {$h[f_{bins},v_{bins}],\sigma, peak_{min}, k_x, k_y, i_{dilate},$ \newline $i_{erode}, t$}
            \For {$row$ \textbf{in} $0{:}f_{bins}$}
                \State $r \gets gaussian\_smooth(h[row,:], \sigma)$
                \State $p \gets find\_peaks(r, peak_{min})$
                \State $ps[p] \gets 1$
            \EndFor
            \State $kernel = cross\_kernel(k_x, k_y)$
            \State $d \gets dilate(ps, i_{dilate}, kernel)$
            \State $e \gets erode(d, i_{erode}, kernel)$
            \State $cs \gets find\_contours(e)$
            \For {$i$ \textbf{in} $0{:}|cs|$}
                \If {$size(cs[i]) > t$}
                    \State $l \gets draw\_contour(l, cs[i], i+1)$
                \EndIf
            \EndFor
            \Return $l$
        \EndFunction
    \end{algorithmic}
\end{algorithm}

\begin{figure}
    %\includegraphics[width=0.5\linewidth]{figures/curves_edt.png}%
    %\includegraphics[width=0.5\linewidth]{figures/curves_diffusion.png}
    \includegraphics[width=\linewidth]{figures/ridges_gauss+edt-bone_region3.pdf}
    \carl{intermediate images of all of the steps?}
    \caption{Detected ridges from the combined field histogram.}
    \label{fig:curves}
\end{figure}

\vspace{\baselineskip}
\noindent\textbf{4. Compute models for material probability distributions} \\
\input{prob.tex}

\vspace{\baselineskip}
\noindent\textbf{5. Perform segmentation}

The final step of the segmentation process is to utilize the probabilities for segmentation.
This process is fairly straightforward, as each voxel is looked up in the probability distribution, which carries the same shape as the field histogram.

\begin{algorithm}
    \caption{Final segmentation from the probability distributions.}
    \label{alg:segment}
    \begin{algorithmic}
        \Function {Segment} {$voxels[n_z,n_y,n_x], p[f_{bins},v_{bins}],$ \newline $v_{bins}, v_{min}, v_{max}, f_{bins}, f_{min}, f_{max}$}
            \For {$z,y,x$ \textbf{in} $0{:}n_z,0{:}n_y,0{:}n_x$}
                \State $v \gets voxels[z,y,x]$
                \If {$v_{min} \leq v \leq v_{max}$}
                    \State $f \gets voxels[z,y,x]$
                    \If {$f_{min} \leq f \leq f_{max}$}
                        \State $v_i \gets (v_{bins} - 1) - \frac{v - v_{min}}{v_{max} - v_{min}}$
                        \State $f_i \gets (f_{bins} - 1) - \frac{f - f_{min}}{f_{max} - f_{min}}$
                        \State $result[z,y,x] \gets p[f_i, v_i]$
                    \EndIf
                \EndIf
            \EndFor
            \Return $result$
        \EndFunction
    \end{algorithmic}
\end{algorithm}

\subsection{Results of the field segmentation}

\subsubsection{Sub-classification of soft tissue}

With a separation of soft tissue and bone in hand, we 
map out the blood vessel network using connected components analysis. 
The osteocytes are selected by volume and shape: for every connected
component in the feasible volume range, its principal axis and best
ellipsoid is computed and checked against the potential osteocyte shape.

\subsection{Visualizing bone-implant contact and blood-implant contact}

Using a Euclidean Distance Transform (EDT) from the implant, restricted to the
bone region, we can simply mask the voxels that are within a thin shell
of distances, $d_{min} < d(x,y,z) \le d_{max}$. We choose $d_{min} = 0$ and
$d_{max} = 10\mu m$.
We then simply sum over the masked voxels of each tissue type to obtain
and divide by the total to obtain the tissue-to-implant contact per area.
However, this only yields a single number, and it is difficult to verify
its fidelity.

\subsubsection{Histology-comparison}

\begin{figure}
  \centering
  \begin{tabular}{c}
    \includegraphics[width=\linewidth]{figures/770c_pag-bic-xy-1x} \\
    \includegraphics[width=\linewidth]{figures/770c_pag-bic-P01-xy-1x}
  \end{tabular}
  \caption{TBW}
  \label{fig:histology-comparison1}
\end{figure}

\begin{figure}
  \centering
  \begin{tabular}{c}
    \includegraphics[width=\linewidth]{figures/770c_pag-full-P01-yz-1x} \\
    \includegraphics[width=\linewidth]{figures/770c_pag-bic-P01-yz-1x}
  \end{tabular}
  \caption{TBW}
  \label{fig:histology-comparison2}
\end{figure}

\subsubsection{Cylindrical projection of implant contact-surface}

In this subsection, we show how to map the tissue-to-implant contact
surface for visual inspection. The challenge is that the equidistant
region forms a curved surface that cannot simply be flattened. Instead,
we project the voxels onto a cylinder, as shown on Figure \ref{fig:cylinder1}.

\begin{figure}
  \centering
  \begin{tabular}{cc}
    (a) & \begin{tabular}{c}\includegraphics[width=.8\linewidth]{figures/implant-FoR_prime-circle}\end{tabular} \\
    (b) & \begin{tabular}{c}\includegraphics[width=0.4\linewidth]{figures/implant-FoR_cylinder-y}%
  \includegraphics[width=0.5\linewidth]{figures/implant-FoR_cylinder-z2}\end{tabular}
  \end{tabular}
  \caption{
    (a) The implant is divided into 100 segments along its principal axis,
    and for each segment, the circumscribed circle is computed. 
    (b) The best overall cylindrical fit for the implant is computed using
    least squares. The implant contact are projected onto this cylinder,
    and can now be shown in a flat plot.}
  \label{fig:cylinder1}
\end{figure}





%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
